import streamlit as st
import os
import importlib
import sys
import pandas as pd

st.set_page_config(
    page_title="HR & Payroll System",
    page_icon="ğŸ‘¥",
    layout="wide",
    initial_sidebar_state="expanded"
)

# â”€â”€ Custom CSS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("""
<style>
    .stApp { background-color: #f0f2f6; }

    [data-testid="stSidebar"] {
        background: linear-gradient(180deg, #1a237e 0%, #283593 50%, #3949ab 100%);
    }
    [data-testid="stSidebar"] .stMarkdown h1,
    [data-testid="stSidebar"] .stMarkdown h2,
    [data-testid="stSidebar"] .stMarkdown h3,
    [data-testid="stSidebar"] label,
    [data-testid="stSidebar"] .stMarkdown p { color: white !important; }

    .metric-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-left: 4px solid #3949ab;
        margin-bottom: 12px;
    }
    .metric-card h3 { color: #3949ab; font-size: 14px; margin: 0; }
    .metric-card h1 { color: #1a237e; font-size: 28px; margin: 4px 0; }

    .page-header {
        background: linear-gradient(135deg, #1a237e, #3949ab);
        color: white;
        padding: 20px 28px;
        border-radius: 12px;
        margin-bottom: 24px;
    }
    .page-header h1 { color: white; margin: 0; font-size: 26px; }
    .page-header p { color: #c5cae9; margin: 4px 0 0 0; font-size: 14px; }

    .stButton > button {
        background: linear-gradient(135deg, #1a237e, #3949ab);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 20px;
        font-weight: 600;
    }
    .stButton > button:hover {
        background: linear-gradient(135deg, #283593, #3f51b5);
        box-shadow: 0 4px 12px rgba(63,81,181,0.4);
    }

    .dataframe { font-size: 13px !important; }
    .stTabs [data-baseweb="tab"] { font-weight: 600; }
    .stTabs [aria-selected="true"] { color: #1a237e !important; }
</style>
""", unsafe_allow_html=True)

# â”€â”€ Bootstrap paths â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
DATA_DIR = os.path.join(BASE_DIR, "data")
os.makedirs(DATA_DIR, exist_ok=True)

if BASE_DIR not in sys.path:
    sys.path.insert(0, BASE_DIR)

from utils.helpers import (
    EMPLOYEE_COLUMNS, ATTENDANCE_COLUMNS, LEAVE_COLUMNS,
    EMPLOYEES_PATH, ATTENDANCE_PATH, LEAVES_PATH,
    load_config,
)

for path, cols in [
    (EMPLOYEES_PATH, EMPLOYEE_COLUMNS),
    (ATTENDANCE_PATH, ATTENDANCE_COLUMNS),
    (LEAVES_PATH,    LEAVE_COLUMNS),
]:
    if not os.path.exists(path):
        pd.DataFrame(columns=cols).to_csv(path, index=False)

# â”€â”€ Sidebar Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.markdown("## ğŸ‘¥ HR & Payroll")
    st.markdown("---")

    NAV = {
        "ğŸ  Dashboard":        "dashboard",
        "ğŸ‘¤ Employee Master":  "employees",
        "ğŸ• Attendance":       "attendance",
        "ğŸ“Š Payroll":          "payroll",
        "ğŸŒ´ Leave Management": "leaves",
        "âš™ï¸ Settings & Rules": "settings",
    }

    if "current_page" not in st.session_state:
        st.session_state.current_page = "dashboard"

    for label, key in NAV.items():
        if st.button(label, key=f"nav_{key}", use_container_width=True):
            st.session_state.current_page = key
            st.rerun()

    st.markdown("---")
    config = load_config()
    st.markdown(f"**ğŸ¢ {config['company']['name']}**")

# â”€â”€ Page Routing (importlib.reload ensures fresh render every time) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PAGE_MAP = {
    "dashboard":  "pages.dashboard",
    "employees":  "pages.employees",
    "attendance": "pages.attendance",
    "payroll":    "pages.payroll",
    "leaves":     "pages.leaves",
    "settings":   "pages.settings",
}

page = st.session_state.current_page
module_path = PAGE_MAP.get(page, "pages.dashboard")

mod = importlib.import_module(module_path)
importlib.reload(mod)
mod.render()
